var tap = require('tap');
var elastic = require('./../index');
var _ = require('underscore');
var util = require('util');
var fs = require('fs');
var request = require('request');
var path = require('path');
var COM_NOOGLE_ROOT = path.resolve(__dirname, '../../../');
var wrench = require('wrench');

/**
 * note this test DELETES EVERYTHING in the repo - only run it BEFORE you have precious data!
 */

tap.test('status', function (t) {

    function _index_me(){
        elastic.define_index(function(err, response){
            console.log('index_response: %s', response);
            t.end();
        })
    }

    elastic.status(function (err, content) {
        console.log('status content: %s, error: %s', content, err ? err.message : '');
        if (err) {
            if (err.message == 'connect ECONNREFUSED') {
                elastic.init(function (e2, c2) {
                    console.log('init response: %s, error: %s', c2, e2 ? e2.message : '');
                    _index_me();
                })
            }
        } else if (/IndexMissingException/.test(content)) {
            console.log(' .... REINDEXING .....')
            elastic.define_index(function (e3, c3) {
                console.log('REINDEX response: %s, error: %s', c3, e3 ? e3.message : '');

                t.end();
            });
        } else {
            try {
                var content_json = JSON.parse(content);
            } catch (je) {
                console.log('status content error: %s', je.message);
                t.end();
                return;
            }
            t.equal(content_json.ok, true, 'status is ok');
            t.ok(content_json.indices, 'has indices');
            t.ok(content_json.indices.hasOwnProperty('noogle'), 'has a noogle index');

            _index_me();
        }

    })
})