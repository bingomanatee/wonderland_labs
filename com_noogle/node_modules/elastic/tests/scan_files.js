var tap = require('tap');
var child_process = require('child_process');
var path = require('path');

var SCAN_DAEMON = path.resolve(__dirname, '../scan_file_daemon.js');


tap.test('scan file daemon', function (t) {

    console.log('exec: %s', process.execPath)
    console.log('SCAN_DAEMON: %s', SCAN_DAEMON)

    var cp = child_process.spawn(process.execPath, [SCAN_DAEMON]);
    cp.stdout.setEncoding('utf8');
    cp.stderr.setEncoding('utf8');

    cp.on('exit', function (response) {
        t.equal(response, 0, 'respond with 0');
        setTimeout(function () {
            t.end();
        }, 1000)
    })

    var signal_count = 0;
    cp.stdout.on('data', function (data) {
        var s = 'scan file daemon|data retrive|scanning file'.split('|')[signal_count++]
        var regex = new RegExp(s)
        t.ok(regex.test(data), 'got expected signal ' + s);

        console.log('data: %s', '' + data);
    })

    cp.stderr.on('data', function (response) {
        console.log('error: %s', '' + response);
    })


})
