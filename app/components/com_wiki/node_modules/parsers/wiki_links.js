module.exports = function wiki_links(text, cb) {

    var hits = text.match(/\[\[([^\]]+)\]\]/g);
    if (!cb){
        return hits;
    }

    if (hits && hits.length) {

        function link_parts(links) {
            return _.map(links, function (link) {
                var e = link.match(/\[\[([^:\]]+)(:([^\]]+))?\]\]/);
                if (!e) return false;
                return {name:e[1], original:link, label:e[3] ? e[3] : e[1].replace(/_/g, ' ')};
            })
        }

       var parts = link_parts( _.uniq(hits));

    parts.forEach(function (part) {

            var repl = '<a href="/wiki/a/' + scope + '/' + part.name + '" class="wikilink">' + part.label + '</a>';
       do {
           text = text.replace(part.original, repl);
       }   while (text.indexOf(part.original) > -1)
        })
    }

    cb(null, text);
}