

module.exports = function(txt, article, cb){

    function replace_menu(rtxt){

        var sm_re = /<scope_menu>([^<]*)<\/scope_menu>/;

        if(sm_re.test(rtxt)){
            var found_scope_menu = sm_re.exec(rtxt);
            if (found_scope_menu){
                $.get('/wiki/scope_menu/' + found_scope_menu[1], function(menu){
                    replace_menu(rtxt.replace(found_scope_menu[0], menu));
                })
            } else {
                cb(null, rtxt, article);
            }
        } else {
            cb(null, rtxt, article);
        }
    }

    replace_menu(txt);
}