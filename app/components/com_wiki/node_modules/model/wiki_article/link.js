var NE = require('nuby-express');
var Gate = NE.deps.support.nakamura_gate;
var _DEBUG = false;
var _ = require('underscore');

var links_in_text = require('./../../parsers/links_in_text');

module.exports = function (model) {

    return _.bind(function (article, cb, save) {

            var self = this;

            var links = links_in_text(article.content);
            _.each(links, function(link){
                link.scope = article.scope;
                delete(link.original);
            })

            article.link_to = links;
            if (article.markModified){
                article.markModified('link_to');
            }

            if (save){
                article.save(cb);
            } else {
                cb(null, article);
            }

        }
        , model);
}