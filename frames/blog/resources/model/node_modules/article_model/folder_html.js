var _ = require('underscore');
var util = require('util');
var path = require('path');
var fs = require('fs');
var _DEBUG = false;
var Gate = require('gate');

/* ************************************
 * 
 * ************************************ */

/* ******* CLOSURE ********* */

/* ********* EXPORTS ******** */

module.exports = function (folder, cb) {
//	console.log('getting folder articles for %s', folder);
	var self = this;
	var fa = this.folder_articles(folder);

	fa = _.sortBy(function(){
		_.filter(fa, function(a){
			return a.on_folder_homepage;
		});
	}, 'weight');

	var gate = Gate.create();

	var articles = [];

	//console.log('articles for folder %s homepage %s', folder, util.inspect(fa));

	_.each(fa, function(a){
		var l = gate.latch();
		this.get(a, function(err, article){
			if (article) articles.push(article);
			l();
		});
	}, this);

	gate.await(function(){
		console.log('articles count: %s', articles.length);
		var html = _.reduce(articles, function(out, a){
			out.push('<h1>', a.title, '</h1>');
			out.push( self.article_html(a, {folder: folder}));
			return out;
		}, []);

		cb(null, html.join("\n"));
	});

}; // end export function