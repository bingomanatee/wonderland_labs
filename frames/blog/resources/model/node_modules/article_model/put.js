var _ = require('underscore');
var util = require('util');
var path = require('path');
var fs = require('fs');
var _DEBUG = false;
var article_dir = require('./article_dir');
var moment = require('moment');

/* ************************************
 * 
 * ************************************ */

/* ******* CLOSURE ********* */

/* ********* EXPORTS ******** */

module.exports = function (data, done) {
	var file_name = data.file_name.replace(/\.md$/, '');
	var folder = data.folder || '';
	var full_path = path.resolve(article_dir(), folder, file_name + '.md');
	var root = path.resolve(article_dir(), folder);
	var model = this;

	if (!data.revised) {
		data.revised = new Date();
	}

	var revised = moment(data.revised);

	data.revised = revised.format('YYYY-MM-DD hh:mm');

	var backup_folder = path.resolve(root, '.backups');
	if (!fs.existsSync(backup_folder)) {
		fs.mkdirSync(backup_folder);
	}

	var date_suffix = revised.format('YYY-MMM-DDThh-mm');

	var backup_path = path.resolve(backup_folder, data.file_name + '.md.' + date_suffix);

	fs.writeFile(backup_path, data.content, function () {
		fs.writeFile(full_path, data.content, 'utf8', function () {
			delete(data.content);
			var meta_path = path.resolve(article_dir(), folder, file_name + '.json');
			fs.writeFile(meta_path, JSON.stringify(data, true, 4), function () {
				var meta_path_bu = path.resolve(backup_folder, file_name + '.json.' + date_suffix);
				fs.writeFile(meta_path_bu, JSON.stringify(data, true, 4), function () {
					model.init(function () {
						done(null, data);
					});
				});
			});
		});
	});
}