var _ = require('underscore');
var util = require('util');
var path = require('path');
var fs = require('fs');
var _DEBUG = false;
var Gate = require('gate');
var article_dir = require('./article_dir');

/* ************************************
 * 
 * ************************************ */

/* ******* CLOSURE ********* */
var _last_check = 0;
var CACHE_LIFE = 30 * 1000;

/* ********* EXPORTS ******** */

module.exports = function articles_folders(cb) {

	var time = new Date().getTime();

	if ((time - _last_check) > CACHE_LIFE){
		this._folders = 0;
		_last_check = time;
	}

	if (this._folders){
		return cb(null, this._folders);
	}

	var self = this;

	fs.readdir(article_dir(), function (err, files) {
		var gate = Gate.create();
		var folders = [];

		if (err) {
			return cb(err);
		}

		files = _.reject(files, function (file) {
			return /^\./.test(file);
		});

		files.forEach(function (file) {
			var full_path = path.resolve(article_dir(), file);
			var l = gate.latch();

			fs.stat(full_path, function (err, stat) {
				if (stat.isDirectory()) {
					folders.push(file);
				}
				l();
			});
		});

		gate.await(function () {
			self._folders = folders;
			cb(null, folders);
		});
	})
};