var _ = require('underscore');
var util = require('util');
var path = require('path');
var fs = require('fs');
var _DEBUG = false;

/* ************************************
 * 
 * ************************************ */

/* ******* CLOSURE ********* */

/* ********* EXPORTS ******** */

module.exports = function (query, cb) {
	var full_path = this.query_file_path(query);
	console.log('looking for file %s', full_path);
	var self = this;
	fs.exists(full_path, function (ex) {
		if (!ex) {
			cb(new Error('cannot find file ' + query.file_name));
		} else {
			//@TODO: stream;
			fs.readFile(full_path, 'utf8', function (err, content) {
				var data = {
					file_name: query.file_name,
					content:   content
				};

				var meta_path = self.query_json_path(query);
				fs.exists(meta_path, function (e2) {
					if (e2) {
						fs.readFile(meta_path, 'utf8', function (err, content) {
							if (err) {
								cb(err);
							} else {
								try {
									var meta = JSON.parse(content);
									_.extend(meta, data);
									cb(null, meta);
								} catch (jerr) {
									cb(jerr);
								}
							}
						})
					} else {
						cb(new Error('cannot read meta ' + meta_path));
					}
				})
			});
		}
	})
}